name: "CD Pipeline"
on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types: [completed]

jobs:
  Pull-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: AWS Configure
        uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Deploy to all ec2 in asg using ssm
        run: |
          echo "Pulling the image and deploying it in the container"

          ASG_NAME=$(aws autoscaling describe-auto-scaling-groups --query "AutoScalingGroups[0].AutoScalingGroupName" --output text)

          INSTANCE_IDS=$(aws autoscaling describe-auto-scaling-groups \
            --auto-scaling-group-names $ASG_NAME \
            --query "AutoScalingGroups[].Instances[].InstanceId" \
            --output text)

          echo "Found instances: $INSTANCE_IDS"

          echo "Deploying container to all instances via SSM..."

          aws ssm send-command \
            --instance-ids $INSTANCE_IDS \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy latest Docker image" \
            --parameters '{"commands":[
              "sudo -u dockeruser docker pull '${{ secrets.DOCKER_USERNAME }}'/nextjs-website:${{ github.event.workflow_run.head_branch }}",
              "sudo -u dockeruser docker stop nextjs-website || true",
              "sudo -u dockeruser docker rm nextjs-website || true",
              "sudo -u dockeruser docker run -d --name nextjs-website -p 3000:3000 --restart unless-stopped '${{ secrets.DOCKER_USERNAME }}'/nextjs-website:${{ github.event.workflow_run.head_branch }}"
            ]}' \
            --region ${{ secrets.AWS_REGION }}
